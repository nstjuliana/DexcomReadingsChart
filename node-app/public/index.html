<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${websiteName}</title>
    <br>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <script>
        // Enable class-based dark mode instead of media-based
        tailwind.config = {
          darkMode: 'class'
        };
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-300">

    <div class="container mx-auto px-4 max-w-4xl">
        <!-- Website Title + Dark Mode Toggle -->
        <div class="flex justify-between items-center ">
            <h1 class="text-2xl md:text-3xl font-bold text-black-600 dark:text-white">
                <span id="websiteName"></span>
            </h1>
            <button id="themeToggle" class="p-2 rounded-full border-2 hover:bg-gray-100 dark:hover:bg-slate-900 bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600">
                <span class="sun">‚òÄÔ∏è</span>
                <span class="moon hidden">üåô</span>
            </button>
        </div>
        <!-- Website Description -->
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-med md:text-small font-bold text-green-500 dark:text-zinc-400"><i><span id="websiteDescription"></span></i></h2>
        </div>
        
        <!-- Latest Reading Box -->
        <div class="topbox bg-white shadow-lg rounded dark:bg-gray-800 p-6 mb-6 text-gray-800 dark:text-white">
            <div class="text-center">
                <p class="text-lg font-bold text-gray-600 dark:text-gray-300 mb-2">Latest Reading</p>
                <div id="latestValue" class="text-4xl md:text-5xl font-bold text-green-600 dark:text-green-400"></div>
                <div id="latestTime" class="text-lg text-gray-500 dark:text-gray-400 mt-2"></div>
            </div>
        </div>

        <!-- Time Range Buttons -->
        <div class="flex flex-wrap justify-center gap-2 mb-6 ">
            <button class="time-btn bg-blue-500 dark:bg-slate-600 hover:bg-blue-600 dark:hover:bg-slate-800 text-white px-4 py-2 rounded-lg transition duration-200" data-hours="3">3h</button>
            <button class="time-btn bg-blue-500 dark:bg-slate-600 hover:bg-blue-600 dark:hover:bg-slate-800 text-white px-4 py-2 rounded-lg transition duration-200" data-hours="6">6h</button>
            <button class="time-btn bg-blue-500 dark:bg-slate-600 hover:bg-blue-600 dark:hover:bg-slate-800 text-white px-4 py-2 rounded-lg transition duration-200" data-hours="12">12h</button>
            <button class="time-btn bg-blue-500 dark:bg-slate-600 hover:bg-blue-600 dark:hover:bg-slate-800 text-white px-4 py-2 rounded-lg transition duration-200" data-hours="24">24h</button>
            <button class="time-btn bg-blue-500 dark:bg-slate-600 hover:bg-blue-600 dark:hover:bg-slate-800 text-white px-4 py-2 rounded-lg transition duration-200" data-hours="all">All</button>
        </div>

        <!-- Glucose Chart -->
        <div class="bg-white shadow-lg rounded dark:bg-gray-800 rounded-lg shadow-lg p-4">
            <canvas id="glucoseChart"></canvas>
        </div>
    </div>

    <script>
        let chart;
        let labels = [];
        let values = [];
        let currentHours = 6;
        let websiteName;
        let websiteDescription;

        fetch('/config')
            .then(res => {
                if (!res.ok) throw new Error('Failed to fetch config');
                return res.json();
            })
            .then(config => {
                websiteName = config.websiteName || 'Dexcom Readings Chart';
                websiteDescription = config.websiteDescription || 'A chart displaying your Dexcom glucose readings over time.';
                localStorage.setItem('WEBSITE_NAME', websiteName);
                localStorage.setItem('WEBSITE_DESCRIPTION', websiteDescription);
                document.getElementById('websiteName').textContent = websiteName;
                document.getElementById('websiteDescription').textContent = websiteDescription;
            })
            .catch(error => {
                console.error('Config fetch error:', error);
                websiteName = localStorage.getItem('WEBSITE_NAME') || 'Dexcom Readings Chart';
                websiteDescription = localStorage.getItem('WEBSITE_DESCRIPTION') || 'A chart displaying your Dexcom glucose readings over time.';
                document.getElementById('websiteName').textContent = websiteName;
                document.getElementById('websiteDescription').textContent = websiteDescription;
            });

        websiteName = localStorage.getItem('WEBSITE_NAME') || 'Dexcom Readings Chart';
        websiteDescription = localStorage.getItem('WEBSITE_DESCRIPTION');

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('websiteName').textContent = websiteName;
            document.getElementById('websiteDescription').textContent = websiteDescription;
            if(websiteName && latestValue) {
                document.title = `${websiteName}:`;
            }
        });

        function determineTimeUnit(chart) {
            // Calculate the visible range from the x-axis scale
            const xScale = chart.scales.x;
            const xmax = xScale.max; // Current maximum timestamp on the x-axis
            const xmin = xScale.min; // Current minimum timestamp on the x-axis

            const range = xmax - xmin;
            const hourInMs = 60 * 60 * 1000;
            console.log("Determining time unit for range:", range / hourInMs);

            const settings = [
                { maxRange: 1 * hourInMs, unit: 'minute', stepSize: 5 }, // 1 hour
                { maxRange: 2 * hourInMs, unit: 'minute', stepSize: 10 }, // 2 hours
                { maxRange: 3 * hourInMs, unit: 'minute', stepSize: 15 }, // 3 hours
                { maxRange: 6 * hourInMs, unit: 'minute', stepSize: 30 }, // 6 hours
                { maxRange: 12 * hourInMs, unit: 'hour', stepSize: 1 }, // 12 hours
                { maxRange: 24 * hourInMs, unit: 'hour', stepSize: 2 }, // 24 hours
                { maxRange: 48 * hourInMs, unit: 'hour', stepSize: 4 }, // 48 hours
                { maxRange: 96 * hourInMs, unit: 'hour', stepSize: 6 }, // 96 hours
                { maxRange: 192 * hourInMs, unit: 'hour', stepSize: 12 }, // 192 hours
                { maxRange: Infinity, unit: 'day', stepSize: undefined } // More than 192 hours
            ];

            const { unit, stepSize } = settings.find(s => range <= s.maxRange) || settings[settings.length - 1];
            chart.options.scales.x.time.unit = unit;
            chart.options.scales.x.ticks.stepSize = stepSize;
            console.log(`Time unit set to ${unit}${stepSize ? ` with step ${stepSize}` : ''}`);
            chart.update('none');
        }

        function setZoomLimits() {
            if (!chart || !chart.data.datasets[0].data.length) return;
            const xValues = chart.data.datasets[0].data.map(point => point.x.getTime());
            chart.options.plugins.zoom.limits.x = {
                min: Math.min(...xValues),
                max: Math.max(...xValues)
            };
            chart.resetZoom();
            // Update time unit after resetting zoom
            determineTimeUnit(chart);
        }

        function createChart() {
            const ctx = document.getElementById('glucoseChart').getContext('2d');
            if (chart) chart.destroy();

            const isDark = document.documentElement.classList.contains('dark');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Glucose',
                        data: values.map((value, index) => ({
                            x: labels[index],
                            y: value
                        })).filter(point => point.y !== null && point.y !== undefined),
                        borderColor: '#3b82f6',
                        fill: true,
                        tension: 0.3,
                        pointRadius: 2,
                        spanGaps: false,
                        showLine: true,
                        segment: {
                            borderColor: (ctx) => {
                                const prev = ctx.p0DataIndex !== null ? ctx.chart.data.datasets[0].data[ctx.p0DataIndex] : null;
                                const curr = ctx.p1DataIndex !== null ? ctx.chart.data.datasets[0].data[ctx.p1DataIndex] : null;
                                if (prev && curr && labels[ctx.p1DataIndex] - labels[ctx.p0DataIndex] > 16 * 60 * 1000) {
                                    return 'transparent';
                                }
                                return '#3b82f6';
                            }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'h:mm a',
                                    day: 'MM/dd'
                                }
                            },
                            grid: { 
                                color: isDark ? '#4b5563' : '#e5e7eb',
                                drawOnChartArea: true
                            },
                            ticks: {
                                color: isDark ? '#d1d5db' : '#374151',
                                maxRotation: 0,
                                source: 'data',
                                autoSkip: true,
                                includeBounds: true
                            },
                            min: function() {
                                if (labels.length > 0) {
                                    return labels[0].getTime();
                                }
                                return null;
                            },
                            max: function() {
                                if (labels.length > 0) {
                                    return labels[labels.length - 1].getTime();
                                }
                                return null;
                            }
                        },
                        y: {
                            min: 0,
                            max: 250,
                            title: {
                                display: true,
                                text: 'mg/dL',
                                color: isDark ? '#d1d5db' : '#374151'
                            },
                            grid: { 
                                color: isDark ? '#4b5563' : '#e5e7eb'
                            },
                            ticks: {
                                color: isDark ? '#d1d5db' : '#374151'
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'nearest',
                            intersect: false,
                            backgroundColor: isDark ? '#1f2937' : '#ffffff',
                            titleColor: isDark ? '#d1d5db' : '#374151',
                            bodyColor: isDark ? '#d1d5db' : '#374151',
                            callbacks: {
                                label: ctx => `${ctx.raw.y} mg/dL`
                            }
                        },
                        zoom: {
                            limits: {
                                x: { min: 'original', max: 'original' },
                                y: { min: 40, max: 300 }
                            },
                            pan: {
                                enabled: true,
                                mode: 'x',
                                threshold: 0,
                                modifierKey: null
                            },
                            zoom: {
                                wheel: { 
                                    enabled: true,
                                    speed: 0.1
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                                onZoomComplete: function() {
                                    // determineTimeUnit(chart);
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                line70: {
                                    type: 'line',
                                    yMin: 70,
                                    yMax: 70,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                },
                                line180: {
                                    type: 'line',
                                    yMin: 180,
                                    yMax: 180,
                                    borderColor: '#ef4444',
                                    borderWidth: 2,
                                    borderDash: [5, 5]
                                }
                            }
                        },
                    },
                    interaction: {
                        mode: 'nearest',
                        intersect: false
                    }
                }
            });

            chart.resetZoom();
            chart.canvas.addEventListener('mousedown', function() {
                console.log('Canvas mousedown');
            });

            chart.canvas.addEventListener('touchstart', function() {
                console.log('Canvas touchstart');
            });

            chart.canvas.addEventListener('dblclick', function() {
                if (chart) {
                    chart.resetZoom();
                    determineTimeUnit(chart);
                }
            });

            // determineTimeUnit(chart);
        }

        async function fetchData(hours = currentHours, reset = false) {
            try {
                console.log(`Fetching data for ${hours} hours, reset: ${reset}`);
                const limit = hours === 'all' ? 10000 : hours * 12;
                const response = await fetch(`/api/data?limit=${limit}`);
                const result = await response.json();
                
                if (!result.success) throw new Error('Data fetch failed');
                
                const data = result.data;
                const newLabels = data.map(item => new Date(item._datetime));
                const newValues = data.map(item => item._value);

                const hasNewData = newLabels.length > labels.length;
                
                labels = newLabels;
                values = newValues;

                chart.data.labels = labels;
                chart.data.datasets[0].data = values.map((value, index) => ({
                    x: labels[index],
                    y: value
                })).filter(point => point.y !== null && point.y !== undefined);

                if (hasNewData || reset) {
                    await setZoomLimits();
                }
                
                console.log(`Chart updated with ${chart.data.datasets[0].data.length} data points`);
                updateLatestReading();
                determineTimeUnit(chart);
            } catch (error) {
                console.error('Fetch error:', error);
            }
        }

        function updateLatestReading() {
            if (values.length === 0 || labels.length === 0) return;
            const latestValue = values[values.length - 1];
            const latestTime = new Date(labels[labels.length - 1]);
            const now = new Date();
            const diff = Math.floor((now - latestTime) / 1000);
            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;

            document.getElementById('latestValue').textContent = `${latestValue} mg/dL`;
            document.getElementById('latestTime').textContent = `${minutes}m ${seconds}s ago`;
            if (websiteName && latestValue !== undefined) {
                document.title = `${websiteName}: ${latestValue} mg/dL`;
            }
        }

        function updateChartTheme(){
            const isDark = localStorage.getItem('theme') === 'dark' || 
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
            console.log("Updating chart theme to", isDark);

            const scales = chart.options.scales;
            scales.x.grid.color = isDark ? '#4b5563' : '#e5e7eb';
            scales.x.ticks.color = isDark ? '#cfcfcf' : '#3b3b3b';
            scales.y.grid.color = isDark ? '#4b5563' : '#e5e7eb';
            scales.y.ticks.color = isDark ? '#cfcfcf' : '#3b3b3b';
            scales.y.title.color = isDark ? '#cfcfcf' : '#3b3b3b';
            chart.options.plugins.tooltip.backgroundColor = isDark ? '#1f2937' : '#ffffff';
            chart.options.plugins.tooltip.titleColor = isDark ? '#d1d5db' : '#374151';
            chart.options.plugins.tooltip.bodyColor = isDark ? '#d1d5db' : '#374151';
            chart.update('none');
        }

        themeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            themeToggle.querySelector('.sun').classList.toggle('hidden', isDark);
            themeToggle.querySelector('.moon').classList.toggle('hidden', !isDark);
            updateChartTheme();
        });

        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentHours = btn.dataset.hours;
                fetchData(currentHours, true);
                
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                console.log(`Changing to ${currentHours} hours view`);
            });
        });

        window.onload = async () => {
            createChart();
            await fetchData(6, true);
            updateChartTheme();
            setInterval(() => fetchData(currentHours, false), 5000);
            setInterval(updateLatestReading, 1000);

            //Set 6 hour to active button
            document.querySelector('.time-btn[data-hours="6"]').classList.add('active');

            const isDark = localStorage.getItem('theme') === 'dark' ||
                (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) {
                document.documentElement.classList.add('dark');
                themeToggle.querySelector('.sun').classList.add('hidden');
                themeToggle.querySelector('.moon').classList.remove('hidden');
            }
        };

        window.onresize = () => chart?.resize();
    </script>

    <style>
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        #glucoseChart {
            height: calc(50vh) !important;
            min-height: 300px;
            width: 100% !important;
            touch-action: none !important;
            cursor: grab;
        }
        
        #glucoseChart:active {
            cursor: grabbing;
        }
        
        @media (max-width: 640px) {
            #glucoseChart {
                height: calc(35vh) !important;
                min-height: 250px;
            }
        }
        
        .chart-container {
            width: 100%;
            max-width: 100%;
            padding: 0;
            overflow: hidden;
        }
        
        .container {
            max-width: 100% !important;
            width: 100% !important;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        .time-btn.active {
            background-color: #1d4ed8;
        }

        html, body {
            overflow: hidden;
            height: 100%;
            touch-action: none;
        }

        .time-btn {
            background-color: #3b82f6;
        }
        .time-btn:hover {
            background-color: #2563eb;
        }
        .time-btn.active {
            background-color: #1d4ed8;
        }
        .dark .time-btn {
            background-color: #475569;
        }
        .dark .time-btn:hover {
            background-color: #1e293b;
        }
        .dark .time-btn.active {
            background-color: #1d4ed8;
        }
    </style>
</body>
</html>